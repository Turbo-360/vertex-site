<!DOCTYPE html>
<head>
  {{>head}}
  <style>
    .list-box-listing-img {
      max-width: 96px !important;
    }

    .my-profile textarea {
      max-height: 120px;
    }
  </style>
</head>

<body>

<div id="wrapper">
  {{>nav}}

<div class="clearfix"></div>

<div id="dashboard">
	<a href="#" class="dashboard-responsive-nav-trigger">
    <i class="fa fa-reorder"></i> Dashboard Navigation
  </a>

	<div class="dashboard-nav">
		<div class="dashboard-nav-inner">
			<ul data-submenu-title="Account">
				<li id="list-item-profile"><a class="sidebar-menu-option" href="#"><i class="sl sl-icon-user-following"></i> Profile</a></li>
				<li id="list-item-sites"><a class="sidebar-menu-option" href="#"><i class="sl sl-icon-docs"></i> Sites</a></li>
        <li><a href="/account/logout"><i class="sl sl-icon-close"></i> Log Out</a></li>
			</ul>
		</div>
	</div>

	<div class="dashboard-content">

		<div class="row">

			<div class="col-lg-9 col-md-9">
        <div id="content-profile" class="dashboard-list-box margin-top-0">
					<h4 class="gray">Profile Details</h4>
					<div class="dashboard-list-box-static">

            <div class="row">
              <div class="col-lg-8">
                <div class="my-profile">
    							<label>First Name</label>
    							<input id="input-profile-firstName" style="background:#fffffa" value="{{user.firstName}}" type="text" />

                  <label>Last Name</label>
    							<input id="input-profile-lastName" style="background:#fffffa" value="{{user.lastName}}" type="text" />

                  <label>Username</label>
    							<input id="input-profile-username" style="background:#fffffa" value="{{user.username}}" type="text" />

    							<label>Bio</label>
    							<textarea id="input-profile-bio" style="background:#fffffa" name="notes" cols="30" rows="6">{{user.bio}}</textarea>
    						</div>
              </div>

              <div class="col-lg-4">
                <div class="edit-profile-photo">
    							<img id="profile-image" src="{{user.image}}=s512-c" alt="">
    						</div>
                <button id="btn-upload" class="button">Change Photo</button>
              </div>
            </div>

						<button id="btn-update-profile" class="button margin-top-15">Update Profile</button>
					</div>
				</div>

				<div id="content-sites" class="dashboard-list-box margin-top-0">
					<h4 class="gray">Manage Your Sites</h4>
					<ul>
            {{#sites}}
						<li>
							<div class="list-box-listing">
								<div class="list-box-listing-img">
                  <a target="_blank" href="https://{{slug}}.vertex360.co">
                    <img src="{{image}}=s512-c" alt="Vertex 360 | {{name}}" />
                  </a>
                </div>
								<div class="list-box-listing-content">
									<div class="inner">
										<h3><a target="_blank" href="https://{{slug}}.vertex360.co">{{name}}</a></h3>
										<span>{{template.category}}</span>
									</div>
								</div>
							</div>
							<div class="buttons-to-right" style="bottom:0%;top:unset;opacity:1.0">
                <a target="_blank" href="https://{{slug}}.vertex360.co" class="button"><i class="sl sl-icon-share-alt"></i> View Site</a>
								<a href="/admin/pages/{{slug}}" class="button"><i class="sl sl-icon-close"></i> Manage Content</a>
							</div>
						</li>
            {{/sites}}
					</ul>
				</div>

			</div>

      {{>footer}}
		</div>
	</div>

</div>

</div>

  <script type="text/javascript">window.__PRELOADED__ = {{{preloaded}}}</script>
  <script type="text/javascript" src="{{{cdn}}}/dist/js/vendor.min.js"></script>
  <script type="text/javascript" src="https://cdn.turbo360-dev.com/dist/turbo.min.js"></script>
  <script type="text/javascript">
    (function(){
      Mustache.tags = ["<%", "%>"] // change delimiter so it doesn't conflict server side

      var data = window.__PRELOADED__
      var user = data.user
      var selected = data.selected
      var sidebarMenu = ['list-item-profile', 'list-item-sites']

      if (user!=null)
        $('#nav-login').hide()

      var turbo = Turbo({site_id: '5c244564231ff10015a113ea'})
      $('#btn-upload').click(function(event){
        if (user == null)
          return

        turbo.uploadFile({
          apiKey: '16874eb4-417b-4147-9657-18a4a2c8cada',
  				completion: function(err, file){
  					console.log('File Uploaded: ' + JSON.stringify(file))
            // File Uploaded: {"confirmation":"success",
            // "result":{"site":"5c244564231ff10015a113ea","name":"mongo-import.png",
            // "type":"image/png","url":"https://lh3.googleusercontent.com/NEzXrVmiEOrz0ckn37U3nj54sVmtdUGGjoIerWHh6UTd_ndtiiopnABgQxrQ8Lh9_A6SoYds9hDrasCHOM2boCBLadc","size":30826,"timestamp":"2019-01-21T18:24:14.328Z","schema":"blob","id":"5c460e4eac836700155c3b2e"}}

            var imageUrl = file.result.url+'=s512-c'
            $('#profile-image').attr('src', imageUrl)

            var updatedProfile = {
              id: user.id,
              image: file.result.url
            }

            $.ajax({
              url: '/account/update',
              type: 'POST',
              data: updatedProfile,
              success: function(response, status, xhr){
                if (response.confirmation != 'success'){
                  alert('Error - ' + response.message)
                  return
                }

                alert('Profile Successfully Updated')
              },
              error: function(xhr, status, err){
                alert('Error - ' + err.message)
              }
            })
  				}
        })
      })

      var reloadUI = function(){
        if (selected == 'profile'){
          $('#content-sites').css('display', 'none')
          $('#content-profile').css('display', '')
        }

        if (selected == 'sites'){
          $('#content-profile').css('display', 'none')
          $('#content-sites').css('display', '')
        }

        sidebarMenu.forEach(function(listItem){
          var selectedListItem = 'list-item-'+selected
          if (listItem == selectedListItem)
            $('#'+listItem).addClass('active')
          else
            $('#'+listItem).removeClass('active')
        })
      }

      $('.sidebar-menu-option').each(function(i, el){
        $(this).click(function(event){
          if (event)
            event.preventDefault()

          // console.log('TEST: ' + event.target.text)
          selected = event.target.text.trim().toLowerCase()
          reloadUI()
        })
      })

      $('#login-container').html('<a href="/me" class="button">My Account</a>')
      $('#btn-update-profile').click(function(event){
        if (event)
          event.preventDefault()

        if (user == null)
          return

        var updatedProfile = {
          id: user.id,
          firstName: $('#input-profile-firstName').val().trim().toLowerCase(),
          lastName: $('#input-profile-lastName').val().trim().toLowerCase(),
          username: $('#input-profile-username').val().trim(),
          bio: $('#input-profile-bio').val()
        }

        $.ajax({
          url: '/account/update',
          type: 'POST',
          data: updatedProfile,
          success: function(response, status, xhr){
            if (response.confirmation != 'success'){
              alert('Error - ' + response.message)
              return
            }

            alert('Profile Successfully Updated')
          },
          error: function(xhr, status, err){
            alert('Error - ' + err.message)
          }
        })
      })

      reloadUI()
    })()
  </script>
</body>
</html>
