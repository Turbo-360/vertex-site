<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Vertex 360</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://lh3.googleusercontent.com/5SVrpLI9utkuVJbQb48cpD3tar59mgWaWSAM73Ghj8dxFJMD2UOzkhO5ptWDd2uV2eqgSvDCSa-Ad8aOrygXx6nv=s32-c" rel="icon" type="image/png" />
    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,400i,500" rel="stylesheet">

    <link href="{{{cdn}}}/wingman/css/socicon.css" rel="stylesheet" type="text/css" media="all" />
    <link href="{{{cdn}}}/wingman/css/entypo.css" rel="stylesheet" type="text/css" media="all" />
    <link href="{{{cdn}}}/wingman/css/theme.css" rel="stylesheet" type="text/css" media="all" />
</head>

<body>

<div class="main-container">

    <section>
        <div class="container">

            <div class="row">
                <div class="col-md-6 col-lg-4 offset-md-4">
                    <div class="card pricing card-lg">
                        <div class="card-body">
                            <span class="display-4 price-collapse collapse show mt-0 mb-2">Join</span>
                            <span>Create your own Vertex 360 site for free below</span>
                            <hr>
                            <form>
                                <input id="input-register-email" placeholder="Email" type="text" class="form-control mb-2" />
                                <input id="input-register-password" placeholder="Password" type="password" class="form-control mb-2" />
                                <input id="input-site-name" placeholder="Your Site Name" type="text" class="form-control mb-2" />
                            </form>
                            <div id="btn-launch-site-container">
                                <a id="btn-launch-site" href="#" class="btn btn-info btn-lg w-100 mt-3 mb-4">LAUNCH YOUR SITE</a>                            
                            </div>
                            <div style="text-align:center">
                                <small>Already have an account? Sign in <a data-toggle="modal" data-target="#login-modal" style="color:red" href="#">HERE</a></small>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!--end of row-->

        </div>
        <!--end of container-->
    </section>
</div>

<div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content" style="border-radius:4px;max-width:300px;margin:auto">
      <div class="modal-header text-center">
        <img class="mx-auto mt-1 mb-2" style="width:130px" src="https://lh3.googleusercontent.com/hlcLdauNL9UiLa3K4wF5ZPNpHzi50R26y61Ahx7oRMbUNgujN-1SmeC_3zG4EHLBH5WnRhQ1ZS19KF_xcWqkTKoENw=s260" />
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <h4>Log In</h4>
        </div>
        <input id="input-login-email" style="background:#f9f9f9;border:none;padding:0.5125rem 1rem" class="form-control mb-2" type="text" placeholder="Email" />
        <input id="input-login-password" style="background:#f9f9f9;border:none;padding:0.5125rem 1rem" class="form-control mb-3" type="password" placeholder="Password" />
        <hr />
        <button id="input-login" style="width:100%" type="button" class="btn btn-primary btn-lg mb-1">LOG IN</button>
      </div>
    </div>
  </div>
</div>

    <script type="text/javascript">window.__PRELOADED__ = {{{preloaded}}}</script>
    <script type="text/javascript" src="{{{cdn}}}/scripts/vertex-lib.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/jquery.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/popper.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/jquery.smartWizard.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/flickity.pkgd.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/scrollMonitor.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/smooth-scroll.polyfills.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/prism.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/zoom.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/bootstrap.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/wingman/js/theme.js"></script>

    <script>
        (function(){
            var preloaded = window.__PRELOADED__
            var currentUser = preloaded.user // null if not registered
            var template = preloaded.template
            var user = null

            $('#btn-launch-site').click(function(e){
                if (e)
                    e.preventDefault()

                // console.log('validate register fields.')
                var visitor = {
                    email: $('#input-register-email').val(),
                    password: $('#input-register-password').val()
                }

                if (visitor.email.length == 0){
                    alert('Please enter your EMAIL')
                    return
                }

                if (visitor.password.length == 0){
                    alert('Please enter your PASSWORD')
                    return
                }

                var siteName = $('#input-site-name').val()
                if (siteName.length == 0){
                    alert('Please enter a name for your site.')
                    return
                }

                console.log('REGISTER: ' + JSON.stringify(visitor))
                $('#btn-launch-site-container').html('<img style="max-width:30%" src="https://storage.turbo360.co/vertex360-cms-4hujkc/loader.gif" />')
                window.vertexLib.postRequest('/account/register', visitor, function(err, response){
                    if (err){
                        $('#btn-launch-site-container').html('')
                        alert(err.message)
                        return
                    }

                    user = response.user
                    // launchTemplate(user.username)

                    var parts = siteName.toLowerCase().split(' ')
                    var hyphenatedSiteName = parts.join('-')
                    launchTemplate(hyphenatedSiteName)
                })
            })

            // checks if a template is ready when cloning:
            var checkTemplate = function(siteSlug){
                var body = {template:siteSlug}
                window.vertexLib.postRequest('/account/check-template', body, function(err, response){
                    if (err){
                        console.log('TEMPLATE NOT READY: ' + siteSlug)
                        setTimeout(function(){
                            checkTemplate(siteSlug)
                        }, 4000)
                        return
                    }

                    if (response.confirmation != 'success'){
                        setTimeout(function(){
                            checkTemplate(siteSlug)
                        }, 4000)
                        return
                    }

                    console.log('CHECK TEMPLATE: ' + JSON.stringify(response))
                    if (response.confirmation != 'success'){
                        alert('Error - ' + response.message)
                        return
                    }

                    // window.location.href = '/me?selected=sites'
                    window.location.href = 'https://'+siteSlug+'.vertex360.co?vtxtoken='+user.token64
                })
            }

            var launchTemplate = function(name){
                console.log('LAUNCH TEMPLATE: ' + name)
                var body = {
                    name: name,
                    source: template.id // ID of the template being copied
                }

                console.log('launchTemplate: ' + JSON.stringify(body))
                window.vertexLib.postRequest('/account/launch-template', body, function(err, response){
                    if (err){
                        alert('Error: ' + err.message)
                        return
                    }

                    console.log('SITE LAUNCHED: ' + JSON.stringify(response))
                    setTimeout(function(){
                        checkTemplate(response.data.slug)
                    }, 4000)
                })
            }
        })()
    </script>

</body>

</html>
