<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" />
</head>

<body class="container">
	<div class="row">

		<div class="col-md-2 col-md-offset-2">
			<h1>template</h1>
			<hr />
		</div>

		<div class="col-md-6">
			<h1>{{template.name}}</h1>
			<hr />
      <input id="input-site-name" type="text" placeholder="Your Site Name" /><br />
      <button id="btn-launch-template">Use This Template</button>

      <form id="register-form" style="margin-top:40px">
        <input id="input-name" type="text" placeholder="Full Name" /><br />
        <input id="input-email" type="text" placeholder="Email" /><br />
        <input id="input-password" type="password" placeholder="Password" /><br />
        <button id="btn-register">Join</button>
        <input id="input-redirect" type="hidden" value="/template/{{template.slug}}" />
      </form>
		</div>
	</div>

  <script type="text/javascript">window.__PRELOADED_DATA__ = {{{preloaded}}}</script>
  <script type="text/javascript" src="/js/jquery.js"></script>
	<script type="text/javascript" src="/js/mustache.js"></script>
  <script type="text/javascript">
    (function(){
      const data = window.__PRELOADED_DATA__
      const template = data.template
      const user = data.user

      var postRequest = function(url, data, completion){
        $.ajax({
          url: url,
          type: 'POST',
          data: data,
          success: function(response, status, xhr){
            if (response.confirmation != 'success'){
              completion(response, null) // 'data' is the error object here.
  						return
  					}

            completion(null, response)
          },
          error: function(xhr, status, err){
            completion(err, null)
          }
        })
      }

      var launchTemplate = function(){
        if (user == null){
          alert('Please log in or register to clone this site.')
          return
        }

        // var siteName = $('#input-site-name').val().trim() // this needs to be entered by the user
        // if (siteName.length == 0){
        //   alert('Please enter a name for your site')
        //   return
        // }

        var body = {
          name: $('#input-site-name').val().trim() // this needs to be entered by the user,
          source: template.id // ID of the template being copied
        }

        if (body.name.length == 0){
          alert('Please enter a name for your site')
          return
        }

        postRequest('/account/launchtemplate', body, function(err, response){
          if (err){
            alert('Error: ' + err.message)
            return
          }

          console.log('SITE LAUNCHED: ' + JSON.stringify(response))
        })
      }

      // hide register form, user already signed up
      if (user != null){
        $('#register-form').css('visibility', 'hidden')
        $('#btn-launch-template').click(function(event){
          console.log('Launch Template')
          if (event)
            event.preventDefault()

          launchTemplate()
        })
        return
      }

      $('#btn-register').click(function(event){
        if (event)
          event.preventDefault()

        var visitor = {
          fullName: $('#input-name').val().trim(),
          email: $('#input-email').val().trim(),
          password: $('#input-password').val().trim(),
          redirect: $('#input-redirect').val().trim()
        }

        var required = ['password', 'email', 'fullName']
        var missing = null
        required.forEach(function(attr){
          if (visitor[attr].length == 0){
            missing = attr
          }
        })

        if (missing != null){
          alert('Please enter your '+missing.toUpperCase())
          return
        }

        // console.log('Register button clicked: ' + JSON.stringify(visitor))
        postRequest('/account/register', visitor, function(err, data){
          if (err){
            alert(err.message)
            return
          }

          var user = data.user
          if (data.redirect != null){
            window.location.href = data.redirect // redirect to data.redirect endpoint
            return
          }

          window.location.href = '/me' // redirect to account page
        })

      })
    })()
  </script>
</body>
</html>
