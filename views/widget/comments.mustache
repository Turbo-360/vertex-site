<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vertex 360</title>
  <meta name="description" content="" />

  {{>head}}
</head>

<body style="padding-top:0px">
<div class="container pt-0 pb-4">
	<div class="row justify-content-between">
		<div class="col-md-8">
      <div id="comments-header" class="d-none">
        <textarea id="text-area-comment" class="form-control mt-3 mb-1" rows="4" style="padding:0px 8px;resize:none"></textarea>
        <small class="text-muted" id="display-username"></small>
        <button id="btn-submit-comment" class="mb-3 btn btn-success float-right mt-2">Add Comment</button>
      </div>

      <div id="register-or-login" class="mt-4 mb-4 d-none" style="background:#f9f9f9;padding:16px">
        Please join or login to submit a comment:<br />
        <button type="button" class="btn btn-primary mb-0 mt-2 mr-2" data-toggle="modal" data-target="#register-modal">JOIN</button>
        <button type="button" class="btn mb-0 mt-2" data-toggle="modal" data-target="#login-modal">LOGIN</button>
      </div>

      <div id="comments-container">
        {{#comments}}
        <div class="mt-2 d-flex justify-content-between post-preview">
          <div class="pr-4">
            <div class="card-text text-muted small">
                <a href="#">{{ profile.username }}</a>
                <span style="margin:6px">&middot;</span>
                <span>{{ dateString }}</span>
            </div>
            <p class="text-muted">{{{text}}}</p>
          </div>
        </div>
        {{/comments}}
      </div>
		</div>
	</div>
</div>
  {{>footer}}
  {{>auth}}
  <a id="nav-register" style="display:none;" class="nav-link" href="#" data-toggle="modal" data-target="#register-modal">JOIN</a>


  <script type="text/template" id="tpl-comment">
    <div class="mt-2 d-flex justify-content-between post-preview">
      <div class="pr-4">
        <div class="card-text text-muted small">
            <a href="#"><% profile.username %></a>
            <span style="margin:6px">&middot;</span>
            <span><% dateString %></span>
        </div>
        <p class="text-muted"><%{text}%></p>
      </div>
    </div>
  </script>

  {{>scripts}}
  <script type="text/javascript" src="{{{cdn}}}/js/mustache.js"></script>
  <script>
    (function(){
      var userAgent = navigator.userAgent.toLowerCase()

      Mustache.tags = ["<%", "%>"] // change delimiter so it doesn't conflict server side
      var data = window.__PRELOADED__
      var user = data.user
      var site = data.site // full site data
      var schema = data.schema // post, video, episode, etc
      var comments = data.comments || []

      if (user == null)
        $('#register-or-login').removeClass('d-none')
      else
        $('#comments-header').removeClass('d-none')

      /*
      if (userAgent.includes('iphone')){
        window.addEventListener('message', function(event){
          var message = event.data
          console.log('MESSAGE RECEIVED == ' + JSON.stringify(message))
          if (message.type == null)
            return

          if (message.type == 'user-logged-in'){
            user = message.user
            document.getElementById('btn-close-login').click()
            document.getElementById('btn-close-register').click()
            reloadUI()
          }
        })
      } */

      window.addEventListener('message', function(event){
        var message = event.data
        // console.log('MESSAGE RECEIVED == ' + JSON.stringify(message))
        if (message.type == null)
          return

        if (message.type == 'user-logged-in'){
          user = message.user
          document.getElementById('btn-close-login').click()
          document.getElementById('btn-close-register').click()
          reloadUI()
        }
      })


      var reloadUI = function(){
        if (user){
          $('#comments-header').removeClass('d-none')
          $('#register-or-login').addClass('d-none')
          $('#display-username').html('Logged in as '+user.username)
        }
        else {
          $('#comments-header').addClass('d-none')
          $('#register-or-login').removeClass('d-none')
        }

        var tpl = $('#tpl-comment').html()
        var commentsHtml = ''
        comments.forEach(function(comment){
          commentsHtml += Mustache.render(tpl, comment)
        })

        $('#comments-container').html(commentsHtml)
      }

      $('#btn-submit-comment').click(function(event){
        if (event)
          event.preventDefault()

        if (user == null){
          alert('Please login or register to submit comment.')
          document.getElementById('nav-register').click()
          return
        }

        var commentText = $('#text-area-comment').val()
        if (commentText.length == 0){
          alert('Please enter a comment.')
          return
        }

        var threadId = data.thread // ID number
        if (threadId == null){
          console.log('THREAD ID NUMBER MISSING')
          return
        }

        var comment = {
          text: commentText,
          thread: threadId,
          site: JSON.stringify({id:site.id, slug:site.slug, name:site.name, image:site.image}),
          profile: JSON.stringify({
            id: user.id,
            firstName: user.firstName,
            lastName: user.lastName,
            username: user.username,
            slug: user.slug
          })
        }

        window.vertexLib.postRequest('/api/comment', comment, function(err, resp){
          if (err){
            alert('Error - '+err)
            return
          }

          console.log('Comment Created: ' + JSON.stringify(resp))
          $('#text-area-comment').val('')
          comments.unshift(resp.result)
          reloadUI()
        })
      })
    })()
  </script>
</body>
</html>
