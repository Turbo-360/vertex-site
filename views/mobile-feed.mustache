<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/aUXZ1b7hGztCkTopbn0ygH9GM6dkD6PNR3VdCdkwWSg8VwgzLFlF6id8boz-QNYciAOkrjBGLfO1jbszPnP4nxtA" />
  <link rel="apple-touch-startup-image" href="{{{cdn}}}/mobili/images/apple-touch-startup-image-640x920.png">
  <title>Vertex 360</title>
  <meta name="description" content="{{meta.description}}" />

  <link rel="stylesheet" href="{{{cdn}}}/mobili/css/swiper.css" />
  <link rel="stylesheet" href="{{{cdn}}}/mobili/style.css" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,900" rel="stylesheet">

  <style>
    .selected {
      background:#fff;
    }

    .swiper-slide {
      background:#c8c8c8;
    }

    .subnav_header {
      border-bottom:1px solid #ddd
    }

    .sidebar-link a {
      font-size: 16px;
      font-weight: 400;
      color: #333;
    }

    .main_nav_underline {
      width: 100%;
      background: #fff;
      padding: 0px !important;
    }

    .post-preview {
      display: flex;
      border-bottom: 1px solid #ddd;
      width: 100% !important;
      padding: 0px;
      margin: 0px
    }

    .post-preview-container {
      display: flex;
      padding: 0px 0px 4px 2px;
    }

    .post-preview-container a {
      flex:1;
      color:#333;
      font-weight:400;
      font-size:15px
    }

    .post-preview-container img {
      width: 80px;
      height: 80px;
      max-width: 100% !important;
      margin-right: 12px !important;
      border-radius: 0px;
    }
  </style>
</head>

<body id="mobile_wrap">
    <div id="panel-overlay" class="panel-overlay"></div>

    <div class="panel panel-left panel-reveal">
      <div class="swiper-container-subnav multinav">
         <div class="swiper-wrapper">
          <div class="swiper-slide">
            <nav class="main_nav_underline">
              <ul style="padding:20px 0px 20px 0px">
                <li><a href="/"><img src="{{{cdn}}}/mobili/images/icons/gray/home.png" alt="Vertex 360" title="" /><span>Home</span></a></li>
                <li><a href="/feed"><img src="{{{cdn}}}/mobili/images/icons/gray/categories.png" alt="Vertex 360" title="" /><span>Feed</span></a></li>
                <li><a href="/templates"><img src="{{{cdn}}}/mobili/images/icons/gray/photos.png" alt="Vertex 360" title="" /><span>Templates</span></a></li>
                <li><a href="/blog"><img src="{{{cdn}}}/mobili/images/icons/gray/blog.png" alt="" title="Vertex 360" /><span>Blog</span></a></li>
              </ul>
              <img style="width:160px;margin:20px 0px 0px 12px" src="https://lh3.googleusercontent.com/hlcLdauNL9UiLa3K4wF5ZPNpHzi50R26y61Ahx7oRMbUNgujN-1SmeC_3zG4EHLBH5WnRhQ1ZS19KF_xcWqkTKoENw=s320" />
            </nav>
          </div>
        </div>
      </div>
    </div>

    <div class="views">

      <div class="view view-main">
        <div class="pages">
          <div data-page="team" class="page">
            <div class="page-content">

        		<div style="background:#333;" class="navbar navbar--fixed navbar--fixed-top navbar--bg">
        			<div class="navbar__col navbar__col--icon navbar__col--icon-left">
        				<a id="btn-menu-toggle" href="#" data-panel="left" class="open-panel"><img src="{{{cdn}}}/mobili/images/icons/white/menu.png" alt="Vertex 360" /></a>
        			</div>
              <div class="navbar__col navbar__col--title" style="text-align:center">
        				<a href="/"><img style="width:140px;margin-top:6px;margin-right:36px" src="https://lh3.googleusercontent.com/pdS5a8pCwrYEp2dbvBPvBxq1WPO57VexjG0fkCNOSw6lIeUNuLK1PAyizKIWEvX6UgFBVQ9OHzbtkQMhvbS57ZRXww=s280" /></a>
        			</div>
            </div>

             <div id="pages_maincontent">
               <div class="swiper-wrapper">
           			<div class="swiper-slide">
                   <div class="subnav_header">
                     <span>Recent Stories</span>
                     <select id="category-select" style="float:right;margin-top:8px">
                       <option value="news">News</option>
                       <option value="culture">Culture</option>
                       <option value="politics">Politics</option>
                       <option value="tech">Tech</option>
                       <option value="entertainment">Entertainment</option>
                       <option value="sports">Sports</option>
                     </select>
                   </div>
           				<nav class="main_nav_underline">
             				<ul style="width:100%">

                       {{#threads.recent}}
                       <li class="post-preview" id="li-{{id}}">
                         <div style="display:flex" class="post-preview-container">
                           <a style="flex:1" id="{{id}}" class="sidebar-link" target="_blank" href="{{{subject.url}}}">
                             <img src="{{{subject.image}}}=s160-c" alt="Vertex 360" />
                           </a>
                           <div style="flex:3">
                             <div>
                               <a id="{{id}}" style="font-weight:400;font-size:14px;margin-bottom:10px" class="sidebar-link" target="_blank" href="{{{subject.url}}}">
                                 {{subject.title}}
                               </a>
                             </div>
                             <a style="font-size:12px;clear:unset;width:initial" target="_blank" href="{{{site.url}}}">
                               {{subject.dateString}}
                             </a>
                             <span style="padding:0px;margin:2px 8px">&middot;</span>
                             <a style="font-size:12px;clear:unset;width:initial" target="_blank" href="{{{site.url}}}">
                               {{site.name}}
                             </a>
                             <span style="padding:0px;margin:2px 8px">&middot;</span>
                             <a style="font-size:12px;clear:unset;width:initial" href="/feed/{{subject.slug}}">
                               Comments
                             </a>
                           </div>
                         </div>
                       </li>
                       {{/threads.recent}}
             				</ul>
           				</nav>
           			</div>

       		    </div>


             </div>

            </div>
          </div>
        </div>

      </div>
    </div>


    <!-- Register Popup -->
    <div class="popup popup-signup">
        <div class="content-block">
            <h4>REGISTER</h4>
            <div class="loginform">
                <form method="post" style="margin-bottom:4px">
                    <input id="auth-email" type="text" name="Email" class="form_input required" placeholder="Email" />
                    <input id="auth-password" type="password" name="Password" class="form_input required" placeholder="Password" />
                    <button style="background:#43603e;width:100%;padding:16px;border:none;color:#fff;font-size:18px" id="auth-submit" type="submit" class="form_submit" />SIGN UP</button>
                </form>
                <div style="text-align:center">
                  <span id="toggle-auth-text" style="margin-top:6px">Already have an account?</span>
                  <a href="#" id="btn-toggle-auth-mode" style="color:red">LOGIN HERE</a>
                </div>
            </div>
            <div style="text-align:center">
              <img style="width:160px;margin-top:72px" src="https://lh3.googleusercontent.com/hlcLdauNL9UiLa3K4wF5ZPNpHzi50R26y61Ahx7oRMbUNgujN-1SmeC_3zG4EHLBH5WnRhQ1ZS19KF_xcWqkTKoENw=s320" />
            </div>

            <div class="close_popup_button">
                <a id="btn-close-popup" href="#" class="close-popup" data-popup=".popup-signup"><img src="{{{cdn}}}/mobili/images/icons/black/menu_close.png" alt="Vertex 360" /></a>
            </div>
        </div>
    </div>

    <a id="btn-popup-modal" data-popup=".popup-signup" class="open-popup" style="display:none"></a>

    <script type="text/template" id="tpl-comment">
      <div style="border-bottom:1px solid #ededed">
        <p style="font-size:15px;line-height: 1.5;color:#000;padding:12px 12px 0px"><%{text}%></p>
        <div style="padding:0px 12px 6px 12px;text-align:right">
          <small style="font-size:12px;margin-bottom:12px;vertical-align:middle;display:inline-block"><% profile.username %></small>
          <img style="width:24px;height:24px;margin-left:6px;border-radius:50%" src="<%{profile.image}%>=s48-c" alt="Vertex 360" />
        </div>
      </div>
    </script>

    <script type="text/javascript">window.__PRELOADED__ = {{{preloaded}}}</script>
    <script type="text/javascript" src="{{{cdn}}}/scripts/vertex-lib.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/js/mustache.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/mobili/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/mobili/js/jquery.validate.min.js" ></script>
    <script type="text/javascript" src="{{{cdn}}}/mobili/js/swiper.min.js"></script>
    <script type="text/javascript" src="{{{cdn}}}/mobili/js/jquery.custom.js"></script>
    <script>
      (function(){
        var data = window.__PRELOADED__
        var authMode = 'register'

        $('#auth-submit').click(function(e){
          if (e)
            e.preventDefault()

          var credentials = {
            email: $('#auth-email').val().toLowerCase().trim(),
            password: $('#auth-password').val()
          }

          if (credentials.email.length == 0){
            alert('Please Enter Your EMAIL')
            return
          }

          if (credentials.password.length == 0){
            alert('Please Enter Your PASSWORD')
            return
          }

          if (authMode == 'login'){
            // console.log('LOGIN')
            window.vertexLib.postRequest('/account/login', credentials, function(err, resp){
              if (err){
                alert(err.message)
                return
              }

              if (resp.confirmation != 'success'){
                alert(resp.message)
                return
              }

              console.log('LOGGED IN: ' + JSON.stringify(resp.user))
              data.user = resp.user
              window.__PRELOADED__ = data
              $('#user-container').css('display', '')
              $('#user-username').html(resp.user.username)
              $('#user-icon').attr('src', resp.user.image+'=s28-c')
              document.getElementById('btn-close-popup').click()
            })
            return
          }

          // console.log('REGISTER')
          window.vertexLib.postRequest('/account/register', credentials, function(err, resp){
            if (err){
              alert(err.message)
              return
            }

            if (resp.confirmation != 'success'){
              alert(resp.message)
              return
            }

            // console.log('LOGGED IN: ' + JSON.stringify(resp.user))
            data.user = resp.user
            window.__PRELOADED__ = data
            $('#user-container').css('display', '')
            $('#user-username').html(resp.user.username)
            $('#user-icon').attr('src', resp.user.image+'=s28-c')
            document.getElementById('btn-close-popup').click()
          })
        })

        $('#btn-toggle-auth-mode').click(function(e){
          if (e)
            e.preventDefault()

          authMode = (authMode=='login') ? 'register' : 'login'
          if (authMode == 'login'){
            $('#auth-submit').html('LOGIN')
            $('#toggle-auth-text').html('Don\'t have an account?')
            $('#btn-toggle-auth-mode').html('REGISTER HERE')
            return
          }

          $('#auth-submit').html('SIGN UP')
          $('#toggle-auth-text').html('Already have an account?')
          $('#btn-toggle-auth-mode').html('LOGIN HERE')
        })
      })()
    </script>

    <script>
      (function(){
        Mustache.tags = ["<%", "%>"] // change delimiter so it doesn't conflict server side
        var data = window.__PRELOADED__
        var query = data.query // object
        var threads = data.threads // array
        var threadsMap = data.threadsMap // object
        var selectedIndex = data.selectedIndex // number
        var showSidebar = data.showSidebar
        var comments = []
        var isLoading = false

        var currentUser = function(){
          return window.__PRELOADED__.user
        }

        var user = currentUser()
        if (user == null){
          $('#user-container').css('display', 'none')
        }
        else {
          $('#user-username').html(user.username)
          $('#user-icon').attr('src', user.image+'=s28-c')
        }

        var reloadComments = function(){
          var commentTpl = $('#tpl-comment').html()
          var commentsHtml = ''
          comments.forEach(function(comment){
            commentsHtml += Mustache.render(commentTpl, comment)
          })

          $('#comments-container').html(commentsHtml)
        }

        $('#btn-submit-comment').click(function(){
          var user = currentUser()

          // show login/register modal:
          if (user == null){
            document.getElementById('btn-popup-modal').click()
            return
          }

          var selectedThread = threads[selectedIndex]
          if (selectedThread == null){
            return
          }

          var commentText = $('#input-comment').val()
          if (commentText.length == 0){
            alert('Please Enter a Comment.')
            return
          }

          var comment = {
            text: commentText,
            thread: selectedThread.subject.id,
            profile: JSON.stringify({
              id: user.id,
              firstName: user.firstName,
              lastName: user.lastName,
              username: user.username,
              image: user.image,
              slug: user.slug
            })
          }

          window.vertexLib.postRequest('/api/comment', comment, function(err, resp){
            console.log(JSON.stringify(resp))
            if (err){
              alert(err.message)
              return
            }

            if (resp.confirmation != 'success'){
              alert('Error - '+resp.message)
              return
            }

            $('#input-comment').val('')
            comments.unshift(resp.result)
            reloadComments()
          })
        })

        var iframe = document.getElementById('entity-content-iframe')
        iframe.onload = function(){
          isLoading = false
          $('#loading-container').css('display', 'none')
          $('#entity-content-iframe').css('display', '')

          var selectedThread = threads[selectedIndex]
          if (selectedThread==null){
            return
          }

          var header = '<h4 style="margin-bottom:8px;padding:0px">'+selectedThread.subject.title+'</h4>'
          $('#comment-header').html(header)
        }

        $('#category-select').change(function(e){
          console.log('Category Selected: ' + e.target.value)
          var viewportmeta = document.querySelector('meta[name="viewport"]')

          viewportmeta.setAttribute('content', "width=device-width, initial-scale=0")
          console.log(document.querySelector('meta[name="viewport"]'))
        })

        var setActive = function(id){
          threads.forEach(function(thread){
            if (thread.id == id)
              $('#li-'+thread.id).addClass('selected')
            else
              $('#li-'+thread.id).removeClass('selected')
          })
        }

        var connectSidebar = function(){
          $('.sidebar-link').each(function(i, link){
            $(this).click(function(event){
              if (event)
                event.preventDefault()

              console.log('Click Article Link')

              // this slides the main view back and hides sidebar:
              $('#mobile_wrap').attr('class', 'panel-closing')
              $('#panel-overlay').removeClass('active')
              $('#panel-overlay').css('display', '')
              $('#panel-left').removeClass('active')

              // something is currently loading, ignore
              if (isLoading == true)
                return

              isLoading = true
              selectedIndex = i

              $('#loading-container').css('display', '')
              $('#entity-content-iframe').css('display', 'none')

              var threadId = $(this).attr('id')
              var thread = threadsMap[threadId]
              setActive(threadId)
              // console.log('Select Entity: ' + JSON.stringify(thread))

              var site = thread.site
              var url = 'https://'+site.slug+'.vertex360.co/post/'+thread.subject.slug
              $('#entity-content-iframe').attr('src', url)
              window.history.pushState("string", thread.subject.title, "/feed/"+thread.subject.slug)
            })
          })
        }

        var reloadUI = function(){
          // var tpl = $('#tpl-thread-preview').html()
          // var threadsHtml = ''
          // threads.forEach(function(thread){
          //   threadsHtml += Mustache.render(tpl, thread)
          // })
          //
          // $('#threads-sidebar').html(threadsHtml)

          var selectedThread = threads[selectedIndex]
          var url = 'https://'+selectedThread.site.slug+'.vertex360.co/post/'+selectedThread.subject.slug
          $('#entity-content-iframe').attr('src', url)
          setTimeout(function(){
            setActive(selectedThread.id)
            connectSidebar()
          }, 200)
        }

        $('#btn-nav-comments').click(function(e){
          var selectedThread = threads[selectedIndex]
          if (selectedThread==null)
            return

          console.log('Fetch Comments: ' + JSON.stringify(selectedThread))
          window.vertexLib.getRequest('/api/comment?thread='+selectedThread.subject.id, null, function(err, resp){
            if (err){
              console.log('ERR: ' + JSON.stringify(err))
              return
            }

            if (resp.confirmation != 'success'){
              console.log('FAIL: ' + resp.message)
              return
            }

            comments = resp.results
            reloadComments()
          })
        })

        reloadUI()

        if (showSidebar==false)
          return

        // slide out sidebar on initial page load
        setTimeout(function(){
          document.getElementById('btn-menu-toggle').click()
        }, 400)

      })()
    </script>

  </body>
</html>
